# DADA2 pipeline

We need some R packages to run the analyses.  
And we need to set the working directory to our course folder. So change the "USERNAME" to your own username below.
And then run the code block below.  

```{r setup}
setwd("PATH_TO_YOUR_WORKING_DIRECTORY")

.libPaths(c("/projappl/project_201312/project_rpackages_r421", .libPaths()))
libpath <- .libPaths()[1]

library(dada2)
library(phyloseq)
library(microViz)
library(tidyverse)
```

Then we will make two lists of the read files in the folder, one for R1 and one for R2 read files.
And get the samples names from the names of the read files (from R1 read files to be precise.)

```{r}
path <- "02_TRIMMED/"

fnFs <- sort(list.files(path, pattern="_trimmed_1.fastq.gz", full.names = TRUE))
fnRs <- sort(list.files(path, pattern="_trimmed_2.fastq.gz", full.names = TRUE))
# Extract sample names, assuming filenames have format: SAMPLENAME_XXX.fastq
sample.names <- sapply(strsplit(basename(fnFs), "_"), `[`, 1)

plotQualityProfile(fnFs[1:6])
plotQualityProfile(fnRs[1:6])

# Place filtered files in filtered/ subdirectory
filtFs <- file.path(path, "filtered", paste0(sample.names, "_F_filt.fastq.gz"))
filtRs <- file.path(path, "filtered", paste0(sample.names, "_R_filt.fastq.gz"))
names(filtFs) <- sample.names
names(filtRs) <- sample.names

out <- filterAndTrim(fnFs, filtFs, fnRs, filtRs, truncLen=c(300,220),
              maxN=0, maxEE=c(1,1), truncQ=2, rm.phix=TRUE,
              compress=TRUE, multithread=TRUE)
out

errF <- learnErrors(filtFs, multithread=TRUE)
errR <- learnErrors(filtRs, multithread=TRUE)

plotErrors(errF, nominalQ=TRUE)
plotErrors(errR, nominalQ=TRUE)

dadaFs <- dada(filtFs, err=errF, multithread=TRUE)
dadaRs <- dada(filtRs, err=errR, multithread=TRUE)

mergers <- mergePairs(dadaFs, filtFs, dadaRs, filtRs, verbose=TRUE)

seqtab <- makeSequenceTable(mergers)
dim(seqtab)
table(nchar(getSequences(seqtab)))

seqtab.nochim <- removeBimeraDenovo(seqtab, method="consensus", multithread=TRUE, verbose=TRUE)
dim(seqtab.nochim)

sum(seqtab.nochim)/sum(seqtab)

getN <- function(x) sum(getUniques(x))
track <- cbind(out, sapply(dadaFs, getN), sapply(dadaRs, getN), sapply(mergers, getN), rowSums(seqtab.nochim))

colnames(track) <- c("input", "filtered", "denoisedF", "denoisedR", "merged", "nonchim")
rownames(track) <- sample.names
track

taxa <- assignTaxonomy(seqtab.nochim, "silva_nr99_v138.2_toSpecies_trainset.fa.gz", multithread=TRUE)

taxa.print <- taxa 
rownames(taxa.print) <- NULL
head(taxa.print)

saveRDS(seqtab.nochim, "seqtab.rds")
saveRDS(taxa, "taxa.rds")
```

Statistical analysis part

Use R 4.2.1

```{r}
.libPaths(c("/users/antkark/projappl/project_rpackages_r421", .libPaths()))
libpath <- .libPaths()[1]

library(phyloseq)
ASV_table <- readRDS("seqtab.rds")
TAX_table <- readRDS("taxa.rds")

physeq <- phyloseq(otu_table(ASV_table, taxa_are_rows=FALSE), tax_table(as.matrix(TAX_table)))

dna <- Biostrings::DNAStringSet(taxa_names(physeq))
names(dna) <- taxa_names(physeq)
physeq <- merge_phyloseq(physeq, dna)

taxa_names(physeq) <- paste0("ASV", seq(ntaxa(physeq)))


physeq_meta <- read_delim("doc/metadata_bacteria.csv", delim=";", locale=locale(decimal_mark = ",")) %>% column_to_rownames("Run")
sample_data(physeq) <- physeq_meta %>% sample_data()

saveRDS(physeq, "physeq.rds")
```

Preliminary community data exploration

```{r}
library(microViz)

physeq <- readRDS("physeq.rds")

ord_explore(physeq)
```